<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>GVU Medical Records â€” Student Portal</title>
    <link rel="icon" type="image/x-icon" href="/WhatsApp Image 2025-09-10 at 12.08.49_f0d52896.jpg" sizes="32x32">
    <link rel="apple-touch-icon" href="/WhatsApp Image 2025-09-10 at 12.08.49_f0d52896.jpg" sizes="180x180">
    <link rel="icon" type="image/png" href="/WhatsApp Image 2025-09-10 at 12.08.49_f0d52896.jpg" sizes="192x192">
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;500;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --primary: #2196F3;
            --secondary: #4CAF50;
            --accent: #FF9800;
            --bg: linear-gradient(135deg, #E3F2FD 0%, #F3E5F5 100%);
            --card: rgba(255, 255, 255, 0.95);
            --text: #1a1a1a;
            --muted: #757575;
            --shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
        }
        body {
            margin: 0;
            font-family: 'Roboto', sans-serif;
            background: var(--bg), url('/background\ logo.jpg') no-repeat center/cover fixed;
            color: var(--text);
            position: relative;
            overflow-x: hidden;
        }
        body::before {
            content: '';
            position: fixed;
            top: 0; left: 0; right: 0; bottom: 0;
            background: rgba(255, 255, 255, 0.8);
            z-index: -1;
        }
        header {
            background: linear-gradient(90deg, var(--primary), #1976D2);
            padding: 16px 24px;
            display: flex;
            align-items: center;
            gap: 16px;
            color: white;
            box-shadow: var(--shadow);
            animation: slideDown 0.6s ease-out;
        }
        @keyframes slideDown {
            from { transform: translateY(-100%); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }
        .logo {
            width: 100px; height: 100px; border-radius: 12px; object-fit: cover; background: white; padding: 4px; box-shadow: 0 4px 12px rgba(0,0,0,0.2);
        }
        .header-text { font-weight: 500; }
        .header-subtitle { font-size: 0.9rem; opacity: 0.9; }
        .container {
            max-width: 900px; margin: 32px auto; padding: 0 16px;
        }
        .card {
            background: var(--card); padding: 24px; border-radius: 16px; box-shadow: var(--shadow);
            margin-bottom: 24px; opacity: 0; transform: translateY(20px);
            animation: fadeUp 0.8s ease-out forwards;
        }
        .card:nth-child(1) { animation-delay: 0.1s; }
        .card:nth-child(2) { animation-delay: 0.2s; }
        .card:nth-child(3) { animation-delay: 0.3s; }
        @keyframes fadeUp {
            to { opacity: 1; transform: translateY(0); }
        }
        h2, h3 { margin: 0 0 16px; font-weight: 400; color: var(--text); }
        label { display: block; font-size: 0.95rem; color: var(--muted); margin: 12px 0 6px; font-weight: 300; }
        input, button, select, textarea {
            font-family: inherit; width: 100%; padding: 12px 16px; border-radius: 10px; border: 2px solid #e0e0e0;
            box-sizing: border-box; transition: all 0.3s ease;
        }
        input:focus, select:focus, textarea:focus { border-color: var(--primary); outline: none; box-shadow: 0 0 0 3px rgba(33, 150, 243, 0.1); }
        button { background: linear-gradient(90deg, var(--secondary), #45a049); color: white; border: none; cursor: pointer; font-weight: 500;
            transition: transform 0.2s ease, box-shadow 0.2s ease; margin: 8px 0;
        }
        button:hover { transform: scale(1.02); box-shadow: 0 4px 12px rgba(76, 175, 80, 0.3); }
        .linklike { background: none; border: none; color: var(--primary); cursor: pointer; padding: 0; font-size: 0.95rem; text-decoration: underline; }
        .linklike:hover { color: #1976D2; }
        .row { display: flex; gap: 16px; flex-wrap: wrap; }
        .col { flex: 1; min-width: 200px; }
        .tips { text-align: center; padding: 20px; background: linear-gradient(180deg, #e8f5e8, white); border-radius: 12px; font-weight: 400;
            min-height: 80px; display: flex; align-items: center; justify-content: center; position: relative; overflow: hidden;
        }
        .tips::before { content: ''; position: absolute; top: 0; left: -100%; width: 100%; height: 100%; background: linear-gradient(90deg, transparent, rgba(255,255,255,0.4), transparent);
            animation: shimmer 3s infinite; }
        @keyframes shimmer { 0% { left: -100%; } 100% { left: 100%; } }
        .visits { max-height: 400px; overflow-y: auto; }
        .visit-item { background: #f9f9f9; padding: 16px; border-radius: 10px; margin-bottom: 12px; border-left: 4px solid var(--secondary); transition: all 0.3s ease; }
        .visit-item:hover { transform: translateX(4px); box-shadow: var(--shadow); }
        .actions { display: flex; gap: 12px; flex-wrap: wrap; }
        .muted { color: var(--muted); font-size: 0.9rem; }
        #app { display: none; animation: fadeIn 0.5s ease-out; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        .loading { text-align: center; color: var(--muted); }
        @media (max-width: 768px) { .row { flex-direction: column; } header { padding: 12px 16px; flex-direction: column; text-align: center; gap: 8px; } }
    </style>
</head>
<body>
    <header>
        <img class="logo" src="/WhatsApp Image 2025-09-10 at 12.08.49_f0d52896.jpg" alt="GVU Logo" onerror="this.style.display='none'">
        <div class="header-text">GVU Medical Records</div>
        <div class="header-subtitle">Student Portal</div>
        <div style="margin-left:auto">
            <button id="btnLogout" style="display:none;background:white;color:var(--primary);padding:8px 16px;border-radius:8px;font-weight:500">Logout</button>
        </div>
    </header>

    <div class="container">
        <div id="authCard" class="card">
            <h2>Welcome to Student Portal</h2>
            <div id="authForms">
                <div id="loginForm">
                    <label for="loginEmail">Email</label>
                    <input id="loginEmail" type="email" placeholder="you@example.com">
                    <label for="loginPassword">Password</label>
                    <input id="loginPassword" type="password" placeholder="password">
                    <div class="actions">
                        <button id="btnLogin">Login</button>
                        <button id="showRegister" class="linklike">Create account</button>
                        <button id="showReset" class="linklike">Forgot password?</button>
                    </div>
                    <div id="loginMsg" class="muted"></div>
                </div>
                <div id="registerForm" style="display:none">
                    <label for="regEmail">Email</label>
                    <input id="regEmail" type="email">
                    <div class="row">
                        <div class="col"><label for="regFirst">First Name</label><input id="regFirst"></div>
                        <div class="col"><label for="regLast">Last Name</label><input id="regLast"></div>
                    </div>
                    <label for="regMatric">Matric Number</label>
                    <input id="regMatric" placeholder="GVU/2024/001">
                    <label for="regPassword">Password</label>
                    <input id="regPassword" type="password" placeholder="choose a secure password">
                    <div class="actions">
                        <button id="btnRegister">Register</button>
                        <button id="cancelRegister" class="linklike">Back to login</button>
                    </div>
                    <div id="regMsg" class="muted"></div>
                </div>
                <div id="resetForm" style="display:none">
                    <label for="resetEmail">Email (for reset link)</label>
                    <input id="resetEmail" type="email" placeholder="Enter your email">
                    <div class="actions">
                        <button id="btnReset">Send reset email</button>
                        <button id="cancelReset" class="linklike">Back to login</button>
                    </div>
                    <div id="resetMsg" class="muted"></div>
                </div>
            </div>
        </div>

        <div id="app">
            <div class="card row" style="align-items:center;justify-content:space-between">
                <div style="display:flex;gap:16px;align-items:center;flex:1">
                    <div style="background:var(--primary);width:60px;height:60px;border-radius:50%;display:flex;align-items:center;justify-content:center;color:white;font-size:1.5rem">ðŸ‘¤</div>
                    <div>
                        <h3 id="studentName">Student Name</h3>
                        <div class="muted" id="studentEmail">email</div>
                        <div class="muted" id="studentMatric">GVU/XXXX</div>
                    </div>
                </div>
                <div style="text-align:right">
                    <div class="muted">Total Visits</div>
                    <div id="totalVisits" style="font-size:2rem;font-weight:700;color:var(--secondary)">0</div>
                </div>
            </div>

            <div class="card">
                <h3>Daily Health Tips</h3>
                <div class="tips" id="tipsCarousel">Loading tips...</div>
            </div>

            <div class="card">
                <h3>Your Visit History & Prescriptions</h3>
                <div id="visitsList" class="visits">
                    <div class="loading">Loading visits...</div>
                </div>
            </div>

            <div id="editPanel" class="card" style="display:none">
                <h3>Edit Profile</h3>
                <label for="editFirst">First Name</label>
                <input id="editFirst">
                <label for="editLast">Last Name</label>
                <input id="editLast">
                <label for="editContact">Contact</label>
                <input id="editContact" placeholder="Phone or other contact">
                <label for="currentPassword">Current Password (required for changes)</label>
                <input id="currentPassword" type="password" placeholder="current password">
                <label for="newPassword">New Password (optional)</label>
                <input id="newPassword" type="password" placeholder="new password">
                <div class="actions">
                    <button id="btnSaveProfile">Save Changes</button>
                    <button id="btnCancelEdit" class="linklike">Cancel</button>
                </div>
                <div id="editMsg" class="muted"></div>
            </div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-app.js";
        import {
            getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword,
            sendPasswordResetEmail, signOut, onAuthStateChanged, reauthenticateWithCredential,
            EmailAuthProvider, updatePassword
        } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-auth.js";
        import {
            getFirestore, doc, setDoc, getDoc, updateDoc, onSnapshot
        } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyAoijzN2PvUTtQn1jVjALBStXup-Xfmv9Q",
            authDomain: "gvu-medical-records.firebaseapp.com",
            projectId: "gvu-medical-records",
            storageBucket: "gvu-medical-records.firebasestorage.app",
            messagingSenderId: "550094376325",
            appId: "1:550094376325:web:530ed47e06da48791c88ec"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        const $ = id => document.getElementById(id);
        function escapeHtml(s) { return String(s || "").replaceAll("&", "&amp;").replaceAll("<", "&lt;").replaceAll(">", "&gt;"); }

        const loginForm = $("loginForm"), registerForm = $("registerForm"), resetForm = $("resetForm");
        const authCard = $("authCard"), appCard = $("app");
        const btnLogout = $("btnLogout"), btnLogin = $("btnLogin"), btnRegister = $("btnRegister");
        const showRegister = $("showRegister"), cancelRegister = $("cancelRegister");
        const showReset = $("showReset"), cancelReset = $("cancelReset");
        const loginMsg = $("loginMsg"), regMsg = $("regMsg"), resetMsg = $("resetMsg");
        const visitsList = $("visitsList");

        const tips = [
            "Drink 8 glasses of water daily to stay hydrated.",
            "Get 7-8 hours of sleep for better health.",
            "Exercise 30 minutes daily to stay active.",
            "Eat fruits and vegetables for a balanced diet.",
            "Wash hands regularly to prevent infections.",
            "Consult a doctor before taking any medication.",
            "Take screen breaks to reduce eye strain.",
            "Maintain good posture to avoid back pain."
        ];
        let tipIndex = 0;
        function tickTip() {
            const tipsEl = $("tipsCarousel");
            tipsEl.style.opacity = '0';
            setTimeout(() => {
                tipsEl.textContent = tips[tipIndex];
                tipsEl.style.opacity = '1';
                tipIndex = (tipIndex + 1) % tips.length;
            }, 200);
        }
        tickTip();
        setInterval(tickTip, 4000);

        showRegister.addEventListener("click", () => {
            loginForm.style.display = "none"; registerForm.style.display = "block"; resetForm.style.display = "none";
        });
        cancelRegister.addEventListener("click", () => {
            loginForm.style.display = "block"; registerForm.style.display = "none"; resetForm.style.display = "none";
        });
        showReset.addEventListener("click", () => {
            loginForm.style.display = "none"; registerForm.style.display = "none"; resetForm.style.display = "block";
        });
        cancelReset.addEventListener("click", () => {
            loginForm.style.display = "block"; registerForm.style.display = "none"; resetForm.style.display = "none";
        });

        btnRegister.addEventListener("click", async () => {
            regMsg.textContent = "";
            const email = $("regEmail").value.trim();
            const first = $("regFirst").value.trim();
            const last = $("regLast").value.trim();
            const matric = $("regMatric").value.trim();
            const password = $("regPassword").value;
            if (!email || !first || !last || !matric || !password) {
                regMsg.textContent = "Please fill all required fields";
                return;
            }
            try {
                const cred = await createUserWithEmailAndPassword(auth, email, password);
                const uid = cred.user.uid;
                await setDoc(doc(db, "students", uid), {
                    uid, email, first, last, matric, contact: "", visits: [], createdAt: new Date().toISOString()
                });
                regMsg.textContent = "Account created successfully! Redirecting...";
                setTimeout(() => location.reload(), 1500);
            } catch (err) {
                console.error(err);
                regMsg.textContent = "Error: " + (err.message || err.code);
                regMsg.style.color = 'red';
            }
        });

        btnLogin.addEventListener("click", async () => {
            loginMsg.textContent = "";
            const email = $("loginEmail").value.trim();
            const pass = $("loginPassword").value;
            if (!email || !pass) {
                loginMsg.textContent = "Please enter email and password";
                return;
            }
            try {
                await signInWithEmailAndPassword(auth, email, pass);
                loginMsg.textContent = "Logging in...";
            } catch (err) {
                console.error(err);
                loginMsg.textContent = "Login failed: " + (err.message || err.code);
                loginMsg.style.color = 'red';
            }
        });

        $("btnReset").addEventListener("click", async () => {
            resetMsg.textContent = "";
            const email = $("resetEmail").value.trim();
            if (!email) {
                resetMsg.textContent = "Please enter your email";
                return;
            }
            try {
                await sendPasswordResetEmail(auth, email);
                resetMsg.textContent = "Reset email sent. Check your inbox.";
                resetMsg.style.color = 'green';
            } catch (err) {
                resetMsg.textContent = "Failed: " + (err.message || err.code);
                resetMsg.style.color = 'red';
            }
        });

        onAuthStateChanged(auth, async user => {
            if (user) {
                try {
                    visitsList.innerHTML = '<div class="loading">Loading profile...</div>';
                    const snap = await getDoc(doc(db, "students", user.uid));
                    if (snap.exists()) {
                        showApp(snap.data(), user.uid);
                    } else {
                        await setDoc(doc(db, "students", user.uid), {
                            uid: user.uid, email: user.email, first: "", last: "", matric: "", contact: "", visits: [], createdAt: new Date().toISOString()
                        });
                        const snap2 = await getDoc(doc(db, "students", user.uid));
                        showApp(snap2.data(), user.uid);
                    }
                } catch (err) {
                    console.error("Failed to load profile", err);
                    visitsList.innerHTML = '<div class="muted">Error loading profile. <button onclick="location.reload()" class="linklike">Retry</button></div>';
                }
            } else {
                authCard.style.display = "block";
                appCard.style.display = "none";
                btnLogout.style.display = "none";
                loginForm.style.display = "block";
                registerForm.style.display = "none";
                resetForm.style.display = "none";
            }
        });

        async function showApp(studentData, uid) {
            authCard.style.display = "none";
            appCard.style.display = "block";
            btnLogout.style.display = "block";
            $("studentName").textContent = (studentData.first || "") + " " + (studentData.last || "");
            $("studentEmail").textContent = studentData.email || "";
            $("studentMatric").textContent = studentData.matric || "";
            $("totalVisits").textContent = (studentData.visits || []).length;
            renderVisits(studentData.visits || []);
            $("editFirst").value = studentData.first || "";
            $("editLast").value = studentData.last || "";
            $("editContact").value = studentData.contact || "";
            onSnapshot(doc(db, "students", uid), snap => {
                if (!snap.exists()) return;
                const d = snap.data();
                $("studentName").textContent = (d.first || "") + " " + (d.last || "");
                $("studentMatric").textContent = d.matric || "";
                $("totalVisits").textContent = (d.visits || []).length;
                renderVisits(d.visits || []);
            });
        }

        function renderVisits(visits) {
            if (!visits || !visits.length) {
                visitsList.innerHTML = '<div class="muted text-center">No visits recorded yet. Schedule one with the clinic!</div>';
                return;
            }
            visitsList.innerHTML = visits.slice().reverse().map(v => {
                const pres = (v.prescriptions || []).map(p => `<div class="muted small">${escapeHtml(p)}</div>`).join("");
                return `<div class="visit-item">
                    <div><strong>${escapeHtml(v.date || "Recent")}</strong> <span class="muted"> â€” By ${escapeHtml(v.clinician || "Clinician")}</span></div>
                    <div class="muted"><em>Diagnosis: ${escapeHtml(v.diagnosis || "General checkup")}</em></div>
                    <div style="margin-top:8px">${escapeHtml(v.notes || "")}</div>
                    ${pres ? `<div style="margin-top:12px;border-top:1px solid #e0e0e0;padding-top:8px"><strong>Prescriptions:</strong>${pres}</div>` : ""}
                </div>`;
            }).join("");
        }

        btnLogout.addEventListener("click", async () => {
            await signOut(auth);
            location.reload();
        });

        $("btnEditProfile").addEventListener("click", () => $("editPanel").style.display = "block");
        $("btnCancelEdit").addEventListener("click", () => $("editPanel").style.display = "none");

        $("btnSaveProfile").addEventListener("click", async () => {
            const user = auth.currentUser;
            if (!user) return alert("Not signed in");
            const first = $("editFirst").value.trim();
            const last = $("editLast").value.trim();
            const contact = $("editContact").value.trim();
            const currentPass = $("currentPassword").value;
            const newPass = $("newPassword").value;
            const update = { first, last, contact };
            if (newPass) {
                if (!currentPass) return $("editMsg").textContent = "Enter current password to change password"; $("editMsg").style.color = 'red';
                try {
                    const cred = EmailAuthProvider.credential(user.email, currentPass);
                    await reauthenticateWithCredential(user, cred);
                    await updatePassword(user, newPass);
                } catch (err) {
                    console.error(err);
                    return $("editMsg").textContent = "Password change failed: " + (err.message || err.code); $("editMsg").style.color = 'red';
                }
            }
            await updateDoc(doc(db, "students", user.uid), update);
            $("editMsg").textContent = "Profile updated successfully!"; $("editMsg").style.color = 'green';
            setTimeout(() => { $("editMsg").textContent = ""; $("editPanel").style.display = "none"; }, 2000);
        });

        $("btnViewPres").addEventListener("click", () => {
            const visits = document.querySelectorAll('.visit-item');
            if (visits.length === 0) return alert("No prescriptions yet. Check back after a visit!");
            // Scroll to first visit with prescriptions
            const firstPres = document.querySelector('.visit-item div[style*="Prescriptions"]');
            if (firstPres) firstPres.scrollIntoView({ behavior: 'smooth' });
            else alert("No prescriptions found in history.");
        });
    </script>
</body>
</html>