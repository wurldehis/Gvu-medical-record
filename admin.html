<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>GVU Medical Records — Admin</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
  <style>
    :root{ --brand:#0b74d1; --nav-height:64px }
    body{ background:#f4f7fb; margin:0; font-family:system-ui,Segoe UI,Arial; }
    /* login card */
    .login-card{ max-width:420px; margin:6vh auto; padding:22px; border-radius:12px; background:#fff; box-shadow:0 8px 30px rgba(2,12,34,.06) }
    .logo-small{ height:130px; width:130px; border-radius:10px; object-fit:cover; display:block; margin:0 auto 8px auto; }
    /* layout */
    .app-shell{ display:flex; min-height:100vh; }
    .sidebar{ width:240px; background:linear-gradient(180deg,var(--brand),#0b94e0); color:#fff; padding:18px; flex-shrink:0; position:relative }
    .sidebar .nav-link{ color:rgba(255,255,255,.95); padding:.5rem .4rem; border-radius:.4rem }
    .sidebar .nav-link.active, .sidebar .nav-link:hover{ background:rgba(255,255,255,.08) }
    .content-wrap{ flex:1; padding:0; min-height:100vh }
    .topbar{ height:var(--nav-height); background:#fff; border-bottom:1px solid #e9eef6; display:flex; align-items:center; justify-content:space-between; padding:0 16px; gap:12px }
    .brand{ display:flex; align-items:center; gap:12px; }
    .brand img{ height:40px; width:40px; border-radius:8px; object-fit:cover }
    .main-content{ padding:18px; }
    .student-card{ border-radius:10px; box-shadow:0 6px 18px rgba(11,33,60,.04); background:#fff; padding:12px; margin-bottom:16px }
    .drug-row .form-select{ min-width:40% }
    .drug-row .note-input{ flex:1 }
    /* responsive */
    @media (max-width: 768px){
      .sidebar{ position:relative; width:100%; display:none } /* hidden by toggler */
      .sidebar.show{ display:block }
      .brand img{ height:32px; width:32px }
      .topbar{ padding:8px }
      .main-content{ padding:12px }
    }
    /* table */
    .history-table th, .history-table td{ vertical-align:middle; font-size:.92rem }
  </style>
</head>
<body>

  <!-- LOGIN -->
  <div id="loginBox" class="login-card">
    <img id="loginLogo" class="logo-small" src="WhatsApp Image 2025-09-10 at 12.08.49_f0d52896.jpg" alt="logo" onerror="this.src=logoFallback()">
    <h4 class="text-center mb-1">GVU Medical Records</h4>
    <p class="text-center text-muted mb-3 small">Admin portal — sign in to manage student records</p>

    <div class="mb-3">
      <label class="form-label small">Username</label>
      <input id="adminUser" class="form-control" placeholder="admin" />
    </div>

    <div class="mb-3">
      <label class="form-label small">Password</label>
      <div class="input-group">
        <input id="adminPass" class="form-control" type="password" placeholder="••••••" />
        <button id="togglePassword" class="btn btn-outline-secondary" type="button" aria-label="Toggle password">
          <!-- eye icon (hidden by default) -->
          <svg id="icon-eye" xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M1 12s4-7 11-7 11 7 11 7-4 7-11 7S1 12 1 12z"/><circle cx="12" cy="12" r="3"/></svg>
          <svg id="icon-eye-slash" xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="display:none"><path d="M17.94 17.94A10.94 10.94 0 0 1 12 20c-7 0-11-8-11-8a21.74 21.74 0 0 1 5-5.14"/><path d="M1 1l22 22"/></svg>
        </button>
      </div>
    </div>

    <div class="d-grid mt-3">
      <button id="btnLogin" class="btn btn-primary">Login</button>
    </div>
    <div class="text-center mt-3 small text-danger" id="loginError" style="display:none">Invalid login — check credentials</div>
    <div class="text-center mt-3 small text-muted">Default: <strong>admin</strong> / <strong>admin123</strong></div>
  </div>

  <!-- APP -->
  <div id="appShell" class="app-shell" style="display:none">
    <!-- sidebar -->
    <aside id="sidebar" class="sidebar">
      <div class="d-flex align-items-center mb-3">
        <img id="sideLogo" src="WhatsApp Image 2025-09-10 at 12.08.49_f0d52896.jpg" alt="logo" onerror="this.src=logoFallback()" style="height:100px;width:100px;border-radius:8px;object-fit:cover;margin-right:10px">
        <div>
          <div style="font-weight:700">GVU Medical</div>
          <div style="font-size:.85rem;opacity:.95">Admin</div>
        </div>
      </div>

      <nav class="nav flex-column">
        <a href="#" class="nav-link active" data-section="dashboard">Dashboard</a>
        <a href="#" class="nav-link" data-section="students">Manage Students</a>
        <a href="#" class="nav-link" data-section="drugs">Common Drugs</a>
        <a href="#" class="nav-link" data-section="password">Change Password</a>
        <a href="#" class="nav-link text-danger" id="btnLogout">Logout</a>
      </nav>

      <hr style="border-color:rgba(255,255,255,.08)">

      <div class="small text-white-50">Connected storage: <strong>localStorage</strong></div>
    </aside>

    <!-- content -->
    <div class="content-wrap">
      <!-- topbar -->
      <header class="topbar">
        <div class="d-flex align-items-center brand">
          <button id="sidebarToggle" class="btn btn-outline-secondary d-md-none me-2" title="Open menu">☰</button>
          <img id="navLogo" src="WhatsApp Image 2025-09-10 at 12.08.49_f0d52896.jpg" alt="logo" onerror="this.src=logoFallback();" style="height:80px;width:80px;border-radius:6px;object-fit:cover">
          <div>
            <div style="font-weight:700">GVU Medical Records</div>
            <div class="small text-muted">Admin Portal</div>
          </div>
        </div>

        <div class="d-flex align-items-center gap-2">
          <div class="me-2 d-none d-md-block"><input id="searchBar" class="form-control form-control-sm" placeholder="Search student name or matric..." style="min-width:260px"></div>
          <div class="text-end small text-muted d-none d-md-block">Signed in as <strong id="adminLabel">admin</strong></div>
        </div>
      </header>

      <!-- main content -->
      <main class="main-content">
       <!-- DASHBOARD -->
<section id="section-dashboard" style="display:none">
  <h4 class="mb-4">Dashboard</h4>

  <!-- Top Stats -->
  <div class="row g-3 mb-4">
    <div class="col-md-4">
      <div class="card shadow-sm text-center p-3">
        <div class="card-body">
          <h5 id="statStudents" class="display-6 mb-0">0</h5>
          <p class="text-muted mb-0">Total Students</p>
        </div>
      </div>
    </div>
    <div class="col-md-4">
      <div class="card shadow-sm text-center p-3">
        <div class="card-body">
          <h5 id="statVisits" class="display-6 mb-0">0</h5>
          <p class="text-muted mb-0">Total Visits</p>
        </div>
      </div>
    </div>
    <div class="col-md-4">
      <div class="card shadow-sm text-center p-3">
        <div class="card-body">
          <h5 id="statRecent" class="display-6 mb-0">0</h5>
          <p class="text-muted mb-0">Recent Registrations</p>
        </div>
      </div>
    </div>
  </div>
</section>
        <!-- Students section -->
        <section id="section-students" style="display:none">
          <div class="d-flex justify-content-between align-items-center mb-3 gap-2">
            <h4 style="margin:0">Registered Students</h4>
            <div class="d-flex gap-2">
              <input id="searchBarMobile" class="form-control form-control-sm d-md-none" placeholder="Search..." />
              <button id="refreshBtn" class="btn btn-outline-secondary btn-sm">Refresh</button>
            </div>
          </div>

          <div id="studentsList" class="row"></div>
        </section>

        <!-- Drugs section -->
        <section id="section-drugs" style="display:none">
          <h4>Common Drugs (Nigeria)</h4>
          <p class="small text-muted">These are suggested items for quick prescription.</p>
          <ul>
            <li>Paracetamol — pain & fever relief</li>
            <li>Amoxicillin — bacterial infections</li>
            <li>Ibuprofen — pain & inflammation</li>
            <li>Chloroquine — malaria</li>
            <li>Metronidazole — GI infections</li>
            <li>Vitamin C — immune support</li>
            <li>Diclofenac — pain & arthritis</li>
            <li>Ciprofloxacin — UTI</li>
            <li>Artesunate — malaria treatment</li>
            <li>Loratadine — allergies</li>
          </ul>
        </section>

        <!-- Password section -->
        <section id="section-password" style="display:none">
          <h4>Change Admin Password</h4>
          <div class="row g-2" style="max-width:520px">
            <div class="col-12"><label class="form-label small">Old password</label><input id="oldPass" type="password" class="form-control" /></div>
            <div class="col-12"><label class="form-label small">New password</label><input id="newPass" type="password" class="form-control" /></div>
            <div class="col-12"><button id="btnChangePass" class="btn btn-success">Update password</button></div>
            <div class="col-12"><div id="passMsg" class="small mt-2"></div></div>
          </div>
        </section>

      </main>
    </div>
  </div>

<script>
/* Admin portal JS
   - Admin account persisted under key 'gvu_admin' as {username, password}
   - Students under key 'students' (array). Student objects expected from student portal.
*/
const LOGIN_KEY = 'gvu_logged_in';
const ADMIN_KEY = 'gvu_admin';
const STUD_KEY = 'students';

// fallback logo (SVG data URI)
function logoFallback(){
  return `data:image/svg+xml;utf8,${encodeURIComponent(`<svg xmlns='http://www.w3.org/2000/svg' width='120' height='120'><rect rx='16' width='100%' height='100%' fill='%230b74d1'/><text x='50%' y='55%' font-size='28' text-anchor='middle' fill='white' font-family='Arial'>GVU</text></svg>`)}`;
}

/* --- admin setup --- */
function getAdmin(){ try { return JSON.parse(localStorage.getItem(ADMIN_KEY)) || null } catch { return null } }
function saveAdmin(obj){ localStorage.setItem(ADMIN_KEY, JSON.stringify(obj)) }
if(!getAdmin()){
  saveAdmin({ username:'admin', password:'admin123' });
}
let admin = getAdmin();

/* element refs */
const loginBox = document.getElementById('loginBox');
const appShell = document.getElementById('appShell');
const btnLogin = document.getElementById('btnLogin');
const loginError = document.getElementById('loginError');
const togglePassword = document.getElementById('togglePassword');
const iconEye = document.getElementById('icon-eye');
const iconEyeSlash = document.getElementById('icon-eye-slash');
const sidebar = document.getElementById('sidebar');
const sidebarToggle = document.getElementById('sidebarToggle');
const btnLogout = document.getElementById('btnLogout');
const adminLabel = document.getElementById('adminLabel');
const searchBar = document.getElementById('searchBar');
const searchBarMobile = document.getElementById('searchBarMobile');
const refreshBtn = document.getElementById('refreshBtn');

/* sections */
const sectDashboard = document.getElementById('section-dashboard');
const sectStudents = document.getElementById('section-students');
const sectDrugs = document.getElementById('section-drugs');
const sectPassword = document.getElementById('section-password');

/* stats elements */
const statStudents = document.getElementById('statStudents');
const statVisits = document.getElementById('statVisits');
const studentsListEl = document.getElementById('studentsList');
const dashboardCards = document.getElementById('dashboardCards');

/* init */
function getStudents(){ try { return JSON.parse(localStorage.getItem(STUD_KEY)) || [] } catch { return [] } }
function saveStudents(arr){ localStorage.setItem(STUD_KEY, JSON.stringify(arr)) }

/* toggle password visibility */
togglePassword.addEventListener('click', ()=>{
  const pass = document.getElementById('adminPass');
  if(pass.type === 'password'){ pass.type='text'; iconEye.style.display='none'; iconEyeSlash.style.display='inline-block'; }
  else { pass.type='password'; iconEye.style.display='inline-block'; iconEyeSlash.style.display='none'; }
});

/* sidebar toggle for small screens */
sidebarToggle?.addEventListener('click', ()=> sidebar.classList.toggle('show'));

/* nav section click */
document.querySelectorAll('.sidebar .nav-link').forEach(a=>{
  a.addEventListener('click',(e)=>{
    e.preventDefault();
    document.querySelectorAll('.sidebar .nav-link').forEach(x=>x.classList.remove('active'));
    a.classList.add('active');
    const sec = a.dataset.section;
    showSection(sec || 'dashboard');
    if(window.innerWidth < 768) sidebar.classList.remove('show');
  });
});

/* show/hide sections */
function showSection(key){
  sectDashboard.style.display = key==='dashboard'? '' : 'none';
  sectStudents.style.display = key==='students'? '' : 'none';
  sectDrugs.style.display = key==='drugs'? '' : 'none';
  sectPassword.style.display = key==='password'? '' : 'none';
  // update search visibility
  if(key==='students'){ if(window.innerWidth >= 768) searchBar.style.display='block'; else searchBarMobile.style.display='block' }
  else { searchBar.value=''; searchBarMobile.value=''; searchBar.style.display='none'; searchBarMobile.style.display='none' }
}

/* login */
btnLogin.addEventListener('click', ()=>{
  const u = (document.getElementById('adminUser').value||'').trim();
  const p = (document.getElementById('adminPass').value||'').trim();
  admin = getAdmin();
  if(admin && u === admin.username && p === admin.password){
    loginError.style.display='none';
    loginBox.style.display='none';
    appShell.style.display='flex';
    adminLabel.textContent = admin.username;
    showSection('dashboard');
    renderDashboard();
    renderStudents();
// on successful login
localStorage.setItem(LOGIN_KEY, JSON.stringify({ loggedIn: true, username: u }));

  } else {
    loginError.style.display='block';
  }
});

/* logout */
btnLogout.addEventListener('click', ()=>{
  appShell.style.display='none';
  loginBox.style.display='';
  document.getElementById('adminPass').value='';
  localStorage.removeItem(LOGIN_KEY);
});

/* Change password */
document.getElementById('btnChangePass').addEventListener('click', ()=>{
  const oldP = document.getElementById('oldPass').value || '';
  const newP = document.getElementById('newPass').value || '';
  const msg = document.getElementById('passMsg');
  admin = getAdmin();
  if(!oldP || !newP){ msg.innerHTML = '<span class="text-danger">Fill both fields</span>'; return; }
  if(admin && oldP === admin.password){
    admin.password = newP;
    saveAdmin(admin);
    msg.innerHTML = '<span class="text-success">Password updated.</span>';
    document.getElementById('oldPass').value=''; document.getElementById('newPass').value='';
  } else {
    msg.innerHTML = '<span class="text-danger">Old password incorrect.</span>';
  }
});

/* Refresh / search */
refreshBtn.addEventListener('click', ()=>{ renderStudents(); renderDashboard(); });
searchBar?.addEventListener('input', ()=> renderStudents(searchBar.value.trim().toLowerCase()));
searchBarMobile?.addEventListener('input', ()=> renderStudents(searchBarMobile.value.trim().toLowerCase()));

/* ---- core rendering ---- */
function renderDashboard() {
  const students = getStudents();
  document.getElementById("statStudents").textContent = students.length;

  // Visits count
  let visitCount = 0;
  students.forEach(s => {
    if (Array.isArray(s.records)) visitCount += s.records.length;
  });
  document.getElementById("statVisits").textContent = visitCount;

  // Recent Registrations (last 7 days)
  const oneWeekAgo = new Date();
  oneWeekAgo.setDate(oneWeekAgo.getDate() - 7);
  const recent = students.filter(s => new Date(s.createdAt) >= oneWeekAgo).length;
  document.getElementById("statRecent").textContent = recent;
}


/* render students list (keeps original indices) */
function renderStudents(filter=''){
  const students = getStudents();
  studentsListEl.innerHTML = '';
  if(!students.length){ studentsListEl.innerHTML = '<div class="col-12"><div class="card p-3">No students registered</div></div>'; return; }
  students.forEach((s, idx) => {
    // filter by name or matric
    const name = (s.name || (s.first? s.first + ' ' + (s.last||'') : '') || '').toLowerCase();
    const matric = (s.matric || '').toLowerCase();
    if(filter && !name.includes(filter) && !matric.includes(filter)) return;
    // card
    const col = document.createElement('div');
    col.className = 'col-12 col-md-6';
    col.innerHTML = `
      <div class="student-card">
        <div class="d-flex justify-content-between align-items-start">
          <div>
            <h5 style="margin:0">${escapeHtml(s.name || (s.first? s.first + ' ' + (s.last||'') : 'Unnamed'))} <small class="text-muted">(${escapeHtml(s.matric||'')})</small></h5>
            <div class="small text-muted">${escapeHtml(s.department||'')}</div>
            <div class="small text-muted">DOB: ${escapeHtml(s.dob||'')}</div>
          </div>
          <div class="text-end small text-muted">${ (s.history||[]).length } visits</div>
        </div>

        <hr/>

        <div class="mb-2">
          <label class="form-label small mb-1">Diagnosis</label>
          <input id="diag-${idx}" class="form-control form-control-sm" placeholder="Enter diagnosis (what the student is sick of)">
        </div>

        <div id="drugs-${idx}">
          <!-- initial drug row will be inserted by JS -->
        </div>

        <div class="d-flex gap-2 mt-2">
        <button class="btn btn-sm btn-outline-danger" onclick="deleteStudent(${idx})">Delete Student</button>
          <button class="btn btn-sm btn-outline-primary" onclick="addDrugRow(${idx})">+ Add Drug</button>
          <button class="btn btn-sm btn-success" onclick="saveRecord(${idx})">Save Record</button>
        </div>

        <hr/>

        <h6 class="mb-2">Medical History</h6>
        <div style="overflow:auto">
          <table class="table table-sm history-table mb-0">
            <thead>
              <tr>
                <th style="min-width:95px">Date</th><th>Diagnosis</th><th>Drugs & notes</th><th>Action</th>
                </tr>
                </thead>
                <tbody id="history-${idx}"></tbody>
          </table>
        </div>
      </div>
    `;
    studentsListEl.appendChild(col);

    // add initial drug row
    if(!document.getElementById(`drugs-${idx}`).hasChildNodes()){
      addDrugRow(idx);
    }

    // render history
    renderHistory(idx);
  });
}

/* add a drug row for a specific student index */
function addDrugRow(idx){
  const container = document.getElementById(`drugs-${idx}`);
  if(!container) return;
  const row = document.createElement('div');
  row.className = 'input-group mb-2 drug-row';
  row.innerHTML = `
    <select class="form-select form-select-sm">
      <option value="">-- select drug --</option>
      <option>Paracetamol</option>
      <option>Amoxicillin</option>
      <option>Ibuprofen</option>
      <option>Chloroquine</option>
      <option>Metronidazole</option>
      <option>Vitamin C</option>
      <option>Diclofenac</option>
      <option>Ciprofloxacin</option>
      <option>Artesunate</option>
      <option>Loratadine</option>
      <option>Azithromycin</option>
      <option>Artemether-Lumefantrine</option>
    </select>
    <input class="form-control form-control-sm note-input" placeholder="Dosage / notes (e.g. 500mg, 3x daily)" />
    <button class="btn btn-outline-danger btn-sm" type="button" title="Remove" onclick="this.parentElement.remove()">✕</button>
  `;
  container.appendChild(row);
}

/* Save record for a student */
function saveRecord(idx){
  const students = getStudents();
  if(!students[idx]) return alert('Student not found (refresh list).');
  const diag = (document.getElementById(`diag-${idx}`).value||'').trim();
  const drugRows = Array.from(document.getElementById(`drugs-${idx}`).querySelectorAll('.drug-row'));
  const prescriptions = [];
  drugRows.forEach(r=>{
    const sel = r.querySelector('select');
    const note = r.querySelector('.note-input');
    if(sel && sel.value){
      prescriptions.push({ drug: sel.value, note: (note && note.value)? note.value.trim() : '' });
    }
  });
  if(!diag){ return alert('Please enter diagnosis.'); }
  if(prescriptions.length === 0){ return alert('Please add at least one drug (use + Add Drug).'); }
  const rec = {
    date: new Date().toISOString(),
    diagnosis: diag,
    prescriptions
  };
  students[idx].history = students[idx].history || [];
  students[idx].history.push(rec);
  saveStudents(students);
  // clear inputs
  document.getElementById(`diag-${idx}`).value = '';
  // remove all drug rows then add a fresh one
  const container = document.getElementById(`drugs-${idx}`);
  if(container){ container.innerHTML = ''; addDrugRow(idx); }
  // refresh UI
  renderHistory(idx);
  renderDashboard();
  alert('Record saved.');
}

/* render history for a student index */
function renderHistory(idx){
  const students = getStudents();
  const tbody = document.getElementById(`history-${idx}`);
  if(!tbody) return;
  tbody.innerHTML = '';
  const hist = (students[idx] && students[idx].history) ? students[idx].history.slice().reverse() : [];
  hist.forEach(h=>{
    const tr = document.createElement('tr');
    const drugsText = (h.prescriptions || [])
      .map(p => p.drug + (p.note ? ` (${p.note})` : ''))
      .join(', ');
    tr.innerHTML = `
      <td style="white-space:nowrap">${new Date(h.date).toLocaleString()}</td>
      <td>${escapeHtml(h.diagnosis)}</td>
      <td>${escapeHtml(drugsText)}</td>
      <td><button class="btn btn-sm btn-danger" onclick="deleteHistory(${idx}, '${h.date}')">✕</button></td>
    `;
    tbody.appendChild(tr);
  });
}


/* search wrapper uses renderStudents so indices remain correct */
function onSearchTerm(term){
  renderStudents(term.toLowerCase().trim());
}

/* bind search bars */
searchBar?.addEventListener('input', (e)=> onSearchTerm(e.target.value));
searchBarMobile?.addEventListener('input', (e)=> onSearchTerm(e.target.value));

/* helper escape */
function escapeHtml(s){ return String(s||'').replaceAll('&','&amp;').replaceAll('<','&lt;').replaceAll('>','&gt;'); }

/* initial rendering helpers */
function renderAll(){
  renderDashboard();
  renderStudents();
}

document.addEventListener('DOMContentLoaded', ()=>{
  const session = JSON.parse(localStorage.getItem(LOGIN_KEY) || 'null');
  if(session && session.loggedIn){
    loginBox.style.display='none';
    appShell.style.display='flex';
    adminLabel.textContent = session.username;
    showSection('dashboard');
    renderDashboard();
    renderStudents();
  }
});



/* Expose small functions for inline onclick (they run in global scope) */
window.addDrugRow = addDrugRow;
window.saveRecord = saveRecord;
window.renderHistory = renderHistory;
window.renderStudents = renderStudents;
window.renderDashboard = renderDashboard;

/* load students when clicking 'Manage Students' nav or refreshing */
document.querySelectorAll('.sidebar .nav-link').forEach(a=>{
  a.addEventListener('click', (ev)=>{
    const sec = a.dataset.section || (a.textContent||'').trim().toLowerCase();
    if(sec === 'students'){ renderStudents(); }
    if(sec === 'dashboard') renderDashboard();
    if(sec === 'drugs') { /* nothing special */ }
  });
});
/* Delete a whole student */
function deleteStudent(idx){
  if(!confirm("Are you sure you want to delete this student and all records?")) return;
  const students = getStudents();
  if(students[idx]){
    students.splice(idx, 1);
    saveStudents(students);
    renderStudents();
    renderDashboard();
    alert("Student deleted.");
  }
}

/* Delete single history record */
function deleteHistory(studentIdx, date){
  const students = getStudents();
  if(!students[studentIdx] || !Array.isArray(students[studentIdx].history)) return;
  students[studentIdx].history = students[studentIdx].history.filter(h => h.date !== date);
  saveStudents(students);
  renderHistory(studentIdx);
  renderDashboard();
}

</script>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
